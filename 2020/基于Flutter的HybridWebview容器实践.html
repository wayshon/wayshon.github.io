<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于Flutter的Hybrid Webview容器实践 | Wayshon 小站</title>
    <meta name="description" content="Wayshon Front-End Developer">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="preload" href="/assets/css/0.styles.f9ac1508.css" as="style"><link rel="preload" href="/assets/js/app.3234abbf.js" as="script"><link rel="preload" href="/assets/js/3.091fb819.js" as="script"><link rel="prefetch" href="/assets/js/10.a48c16b4.js"><link rel="prefetch" href="/assets/js/11.a5419096.js"><link rel="prefetch" href="/assets/js/12.0cbbfb64.js"><link rel="prefetch" href="/assets/js/13.b16df315.js"><link rel="prefetch" href="/assets/js/14.8b3ec47e.js"><link rel="prefetch" href="/assets/js/15.cabe99a1.js"><link rel="prefetch" href="/assets/js/16.a67cc252.js"><link rel="prefetch" href="/assets/js/17.ebb89b66.js"><link rel="prefetch" href="/assets/js/18.a53fbdf8.js"><link rel="prefetch" href="/assets/js/19.e80ac3d4.js"><link rel="prefetch" href="/assets/js/2.dbba3d8d.js"><link rel="prefetch" href="/assets/js/20.53051d6e.js"><link rel="prefetch" href="/assets/js/21.d29f15e7.js"><link rel="prefetch" href="/assets/js/22.0319bfb1.js"><link rel="prefetch" href="/assets/js/23.733b9128.js"><link rel="prefetch" href="/assets/js/24.6f9108aa.js"><link rel="prefetch" href="/assets/js/25.1213099a.js"><link rel="prefetch" href="/assets/js/26.274b0122.js"><link rel="prefetch" href="/assets/js/27.2639d4bf.js"><link rel="prefetch" href="/assets/js/28.b288a6e5.js"><link rel="prefetch" href="/assets/js/29.2fd2e932.js"><link rel="prefetch" href="/assets/js/30.119e4149.js"><link rel="prefetch" href="/assets/js/31.432e6cb3.js"><link rel="prefetch" href="/assets/js/32.011184fe.js"><link rel="prefetch" href="/assets/js/33.00b83608.js"><link rel="prefetch" href="/assets/js/34.d802c816.js"><link rel="prefetch" href="/assets/js/35.33689142.js"><link rel="prefetch" href="/assets/js/36.dc93cc29.js"><link rel="prefetch" href="/assets/js/37.855e33d8.js"><link rel="prefetch" href="/assets/js/38.5495d034.js"><link rel="prefetch" href="/assets/js/39.84dc2dc6.js"><link rel="prefetch" href="/assets/js/4.f95145a6.js"><link rel="prefetch" href="/assets/js/5.12543c1d.js"><link rel="prefetch" href="/assets/js/6.b216a31d.js"><link rel="prefetch" href="/assets/js/7.093a7fe1.js"><link rel="prefetch" href="/assets/js/8.e7981210.js"><link rel="prefetch" href="/assets/js/9.333127fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9ac1508.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wayshon 小站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="基于flutter的hybrid-webview容器实践"><a href="#基于flutter的hybrid-webview容器实践" aria-hidden="true" class="header-anchor">#</a> 基于Flutter的Hybrid Webview容器实践</h1> <p><a href="https://github.com/wayshon/hybrid_webview_flutter" target="_blank" rel="noopener noreferrer">github地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="背景"><a href="#背景" aria-hidden="true" class="header-anchor">#</a> 背景</h3> <p>Flutter 是一个 UI 框架，实际开发中除了常见的 widget 还需要如地图、webview等 Native 组件。</p> <p>一种方法是 Flutter 通知 Native 唤起 Native 界面，如之前的<a href="https://github.com/wayshon/scan_flutter_ios" target="_blank" rel="noopener noreferrer">扫码插件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。缺点是 Native 组件很难和 Flutter 组件进行组合。</p> <p>第二种是通过 Flutter 提供的 PlatformView(AndroidView/UIKitView) 将 Native 组件嵌入到 Flutter的组件树。使 Flutter 能够像控制普通 widget 那样控制 Native 组件。</p> <p><strong>目标: Flutter 中嵌入 webview widget，这个 webview 需要受 flutter 控制，且能够与 flutter 通信。</strong></p> <h3 id="思路"><a href="#思路" aria-hidden="true" class="header-anchor">#</a> 思路</h3> <p><img src="/assets/img/flow.32cf13ac.png" alt></p> <h3 id="具体实现"><a href="#具体实现" aria-hidden="true" class="header-anchor">#</a> 具体实现</h3> <h4 id="target-1-实现-webview-插件"><a href="#target-1-实现-webview-插件" aria-hidden="true" class="header-anchor">#</a> target 1: 实现 webview 插件</h4> <p>1、创建插件:</p> <div class="language- extra-class"><pre class="language-text"><code>flutter create -i objc --template=plugin hybrid_webview_flutter
</code></pre></div><p>自动生成 HybridWebviewFlutterPlugin 类，打开 Runner.xcworkspace</p> <p>2、在 info.flist 添加 io.flutter.embedded_views_preview: YES。PlatformView 功能默认关闭，不配置这行就没法使用
<img src="/assets/img/infoplist.caa59ab4.png" alt></p> <p>3、创建 webview 类，实现 FlutterPlatformView 协议，在构造函数里获取 flutter 传递过来的参数，创建 webview，创建 FlutterMethodChannel 并设置 block 回调。</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>// 注册flutter 与 ios 通信通道
NSString* channelName = [NSString stringWithFormat:@&quot;com.calcbit.hybridWebview_%lld&quot;, viewId];
_channel = [FlutterMethodChannel methodChannelWithName:channelName binaryMessenger:messenger];
__weak __typeof__(self) weakSelf = self;
[_channel setMethodCallHandler:^(FlutterMethodCall *  call, FlutterResult  result) {
	[weakSelf onMethodCall:call result:result];
}];
</code></pre></div><p>4、创建工厂类 WebviewFactory，实现 FlutterPlatformViewFactory 协议，实现协议中的 createWithFrame 方法并返回步骤3创建的 webview</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>//用来创建 ios 原生view
- (nonnull NSObject&lt;FlutterPlatformView&gt; *)createWithFrame:(CGRect)frame viewIdentifier:(int64_t)viewId arguments:(id _Nullable)args {
    //args 为flutter 传过来的参数
    Webview *webView = [[Webview alloc] initWithWithFrame:frame viewIdentifier:viewId arguments:args binaryMessenger:_messenger];
    return webView;
}
</code></pre></div><p>5、步骤1生成的 HybridWebviewFlutterPlugin 注册插件的方法 registerWithRegistrar 中添加一行注册 WebviewFactory</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>[registrar registerViewFactory:[[WebviewFactory alloc] initWithMessenger:registrar.messenger] withId:@&quot;com.calcbit.hybridWebview&quot;];
</code></pre></div><p>6、根目录 lib/ 下新建 hybrid_webview.dart 文件，创建 HybridWebview Widget，build 返回 UiKitView。UiKitView 接收的 viewType 与步骤5注册 Factory 时的 withId 一致。</p> <p>creationParams 可传递参数给步骤3。</p> <p>creationParamsCodec 标准平台通道使用标准消息编解码器，以支持简单的类似JSON值的高效二进制序列化 参考<a href="https://api.flutter.dev/flutter/services/StandardMessageCodec-class.html" target="_blank" rel="noopener noreferrer">StandardMessageCodec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>onPlatformViewCreated 在 UiKitView 创建完成后执行，可获取到 Native 组件的 viewId，注册 MethodChannel，这时候 channel 可与步骤3创建的 webview 进行通信</p> <div class="language-dart extra-class"><pre class="language-dart"><code>Widget <span class="token function">buildWebView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">UiKitView</span><span class="token punctuation">(</span>
      viewType<span class="token punctuation">:</span> <span class="token string">&quot;com.calcbit.hybridWebview&quot;</span><span class="token punctuation">,</span>
      creationParams<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> widget<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//参数的编码方式</span>
      creationParamsCodec<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">StandardMessageCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">//webview 创建后的回调</span>
      onPlatformViewCreated<span class="token punctuation">:</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建通道</span>
        _channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodChannel</span><span class="token punctuation">(</span><span class="token string">'com.calcbit.hybridWebview_$id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置监听</span>
        <span class="token function">nativeMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      gestureRecognizers<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Factory<span class="token operator">&lt;</span>OneSequenceGestureRecognizer<span class="token operator">&gt;&gt;</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">Factory</span><span class="token operator">&lt;</span>OneSequenceGestureRecognizer<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">EagerGestureRecognizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="target-2-flutter-与-native-通信"><a href="#target-2-flutter-与-native-通信" aria-hidden="true" class="header-anchor">#</a> target 2: flutter 与 native 通信</h4> <h5 id="native-调用-flutter"><a href="#native-调用-flutter" aria-hidden="true" class="header-anchor">#</a> native 调用 flutter</h5> <p>target 1 步骤3 创建的 FlutterMethodChannel channel 可以调用 invokeMethod 方法传递消息名，参数给 flutter，并设置 flutter 回调</p> <p>回调参数 result 可能是 flutter Feature 返回值，也有可能是 flutter 运行时报错</p> <h5 id="flutter-调用-native"><a href="#flutter-调用-native" aria-hidden="true" class="header-anchor">#</a> flutter 调用 native</h5> <p>有了 target 1 步骤 6 onPlatformViewCreated 里创建的 channel，使用 channel.invokeMethod 调用 native 方法，第一个参数为消息名，第二个为可选参数。返回一个 Future（类似 js 的 Promise）</p> <p>在 target 1 步骤 3 OC 创建 FlutterMethodChannel 时的 block 可接收到 flutter 的调用信息。第一个参数 FlutterMethodCall 包含了 flutter 调用的消息名与参数，第二个参数 FlutterResult 是一个回调函数，传递给 flutter 返回值。</p> <p>为了扩展性，这里将 invokeMethod 的第一个参数固定为 <code>__flutterCallJs</code>，第二个参数固定为数组，数组第一个参数固定为 js 的目标方法。这样只是用 <code>__flutterCallJs</code> 就不用每增加一个方法就去修改 native 的代码。<br>
Native 调 flutter 的消息名不固定是因为我们能够经常修改 flutter，但是不会经常修改 native</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>-(void)onMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result{
    if ([[call method] isEqualToString:@&quot;__flutterCallJs&quot;]) {
        NSString *action = [call.arguments firstObject];
        NSArray *params;
        if ([call.arguments count] &gt; 1) {
            params = [call.arguments subarrayWithRange:NSMakeRange(1, [call.arguments count] -1)];
        } else {
            params = @[];
        }
        //  在主线程更新 webview，不然会崩
        dispatch_async(dispatch_get_main_queue(), ^{
            [self-&gt;_context[@&quot;__flutterCallJs&quot;] callWithArguments:@[action, params, ^(JSValue *value) {
                NSArray *arr = [value toArray];
                result(arr);
            }]];
        });
    } else if ([[call method] isEqualToString:@&quot;evaluateJavaScript&quot;]) {
        // 注入 js
        NSString* jsString = [call arguments];
        dispatch_async(dispatch_get_main_queue(), ^{
            [self-&gt;_webView stringByEvaluatingJavaScriptFromString:jsString];
        });
    }
}
</code></pre></div><p>下图列举了 native 与 flutter 值的转换
<img src="/assets/img/flutter_oc_value.89fb82e0.png" alt></p> <p>通过实践限制 flutter 调 oc 限制的参数为 bool, int, double, string,List, Map, Null<br>
Set不能传会报错，map 的 key 必须为 string，不然 flutter 传给 OC 没问题，OC传给 js 的时候会剔除掉。如 {'a':1,2:2} 传到 js 就变成了 {'a':1}</p> <h4 id="target-3-webview-与-native-通信"><a href="#target-3-webview-与-native-通信" aria-hidden="true" class="header-anchor">#</a> target 3: webview 与 native 通信</h4> <h5 id="native-调用-js"><a href="#native-调用-js" aria-hidden="true" class="header-anchor">#</a> native 调用 js</h5> <p>在 target 2 中 OC 已经能够接收到 flutter 传递过来的消息，这时候 OC 需要将消息传给 js。可以通过 KVC 获取到 UIWebView 的 JSContext（WKWebView取不到context但是可以通过消息形式）</p> <p>在 webview 定义全局函数 <code>__flutterCallJs</code> 用来接收 OC 传递过来的值。</p> <p>JSContext 执行 <code>__flutterCallJs</code> 透传 flutter 传过来的参数，并多传一个 block 参数，block 在 js 里会变成函数，js 侧调用这个函数类似 callback</p> <p>OC 的 block 接收到 js 执行的回调，调用 FlutterResult，将回调结果返回给 flutter</p> <p>除了获取 js context 执行 js，webview 常见的还有注入 js，可以接收 flutter 传来的 js string 注入到 webview</p> <h5 id="js-调用-native"><a href="#js-调用-native" aria-hidden="true" class="header-anchor">#</a> js 调用 native</h5> <p>1、JSContext 直接注入 bolck，js 调用这个函数</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>_context[@&quot;globalFuction&quot;] = ^(JSValue *value) {
	NSLog(&quot;%@&quot;, value);
};
</code></pre></div><p>2、通过 JSExport 协议，只有 JSExport 里声明的方法才会被 js 访问到</p> <p>定义一个 JSExport 协议，并在 Class A 实现，将 A 实例化并作为全局变量注入到 JSContext，这里为了方便直接在 webview 定义实现 JSExport，将 当期实例 self 注入到 JSContext</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>//定义一个JSExport protocol
@protocol JSExportProtocol &lt;JSExport&gt;
	JSExportAs(jsCallFlutter, - (void)jsCallFlutter:(JSValue *)action params:(JSValue *)params callback:(JSValue *)callback);
@end

//将self添加到context中
_context[@&quot;__OCObj&quot;] = self;
};
</code></pre></div><p>这时候 js 全局链就会有 <code>__OCObj</code> 对象，调用 __OCObj.jsCallFlutter 传递参数给 OC，约定 最后一个参数为 callback，js Function 到 OC 里面会转换成 block</p> <p>OC 通过 FlutterMethodChannel 调用 flutter 获得返回值后通过这个 block 触发 js 的 callback</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>#pragma mark - jsExport
- (void)jsCallFlutter:(JSValue *)action params:(JSValue *)params callback:(JSValue *)callback {
    NSString *actionName = [NSString stringWithFormat:@&quot;%@&quot;, action];
    NSArray *arr = [params toArray];
    [self-&gt;_channel invokeMethod:actionName arguments:arr result:^(id  _Nullable result) {
        if ([result isKindOfClass:[NSClassFromString(@&quot;FlutterError&quot;) class]]) {
            [callback callWithArguments:@[[result valueForKey:@&quot;_message&quot;], [NSNull null]]];
        } else {
            id results;
            if (result) {
                results = result;
            } else {
                results = [NSNull null];
            }
            //  在主线程更新 webview
            dispatch_async(dispatch_get_main_queue(), ^{
                [callback callWithArguments:@[[NSNull null], results]];
            });
        }
    }];
}
</code></pre></div><p>经实践，限制 js 传给 OC 的值为 boolean, number, string, array, obj, null/undefined</p> <p>null/undefined 都会转成 null，fn/set/map都会在OC变成空字典 {}，{1: 'a'} 到了 OC key 也会转成 string</p> <h4 id="target-4-cookie-共享"><a href="#target-4-cookie-共享" aria-hidden="true" class="header-anchor">#</a> target 4: cookie 共享</h4> <p>webView/OC，RN/OC cookie 都是共享的。但是 flutter 比较奇怪，用过的 dart:io 与 <a href="https://pub.flutter-io.cn/packages/dio" target="_blank" rel="noopener noreferrer">dio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 都不自动带上cookie，查看了 <a href="https://pub.flutter-io.cn/packages/dio_cookie_manager" target="_blank" rel="noopener noreferrer">dio_cookie_manager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 与 <a href="https://pub.flutter-io.cn/packages/cookie_jar" target="_blank" rel="noopener noreferrer">cookie_jar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的实现，发现 dio 是利用这两个库自己在 dart 维护了 cookie 信息，然后添加到 dio.interceptors 里，随 request 带上，监听 response 存储。</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// dio &amp; dio_cookie_manager 代码</span>
Future <span class="token function">onRequest</span><span class="token punctuation">(</span>RequestOptions options<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cookies <span class="token operator">=</span> cookieJar<span class="token punctuation">.</span><span class="token function">loadForRequest</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookies<span class="token punctuation">.</span><span class="token function">removeWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span>expires <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cookie<span class="token punctuation">.</span>expires<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String cookie <span class="token operator">=</span> <span class="token function">getCookies</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> options<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>HttpHeaders<span class="token punctuation">.</span>cookieHeader<span class="token punctuation">]</span> <span class="token operator">=</span> cookie<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token metadata symbol">@override</span>
  Future <span class="token function">onResponse</span><span class="token punctuation">(</span>Response response<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_saveCookies</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_saveCookies</span><span class="token punctuation">(</span>Response response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>headers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> cookies <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>HttpHeaders<span class="token punctuation">.</span>setCookieHeader<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cookieJar<span class="token punctuation">.</span><span class="token function">saveFromResponse</span><span class="token punctuation">(</span>
          response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>uri<span class="token punctuation">,</span>
          cookies<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Cookie<span class="token punctuation">.</span><span class="token function">fromSetCookieValue</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>由于这种实现相当于把 response 的 cookie 维护在 dart 层面，所以 OC 的请求就不会有这些信息，webView 环境也不会有。</p> <p>然后？<br> <img src="/assets/img/why.b079817b.png" alt></p> <p>与其将 cookie 信息维护在 dart，为什么不直接维护在 OC，那样OC/webView的请求还能带上。</p> <h5 id="方案"><a href="#方案" aria-hidden="true" class="header-anchor">#</a> 方案</h5> <ul><li>OC 与 webView 的 cookie 是互通的，不用手动处理</li> <li>dart req/res 调用 MethodChannel 读/存 cookie</li> <li>OC 存 cookie 至 NSHTTPCookieStorage，并同步至 webView 的 document.cookie</li></ul> <h5 id="实现"><a href="#实现" aria-hidden="true" class="header-anchor">#</a> 实现</h5> <p>1、 dart 存取 cookie 存到 OC</p> <div class="language-dart extra-class"><pre class="language-dart"><code>  <span class="token comment">// 存</span>
  <span class="token keyword">static</span> Future<span class="token operator">&lt;</span>bool<span class="token operator">&gt;</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token punctuation">{</span> String domain<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String value<span class="token punctuation">,</span> int exp <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    bool result <span class="token operator">=</span> <span class="token keyword">await</span> _channel<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token string">'setCookie'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>domain<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> exp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 取</span>
  <span class="token keyword">static</span> Future<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Map<span class="token operator">&gt;&gt;</span> <span class="token function">getCookie</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> List res <span class="token operator">=</span> <span class="token keyword">await</span> _channel<span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token string">'getCookie'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>Map<span class="token operator">&gt;</span> listMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Map<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> listMap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>2、OC 存取 dart 传过来的值，并在 OC 发送请求时带上这些 cookie</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>// 读 cookie
NSArray *cookieArray = [NSArray arrayWithArray:[[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies]];

// 存 cookie
NSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:cookieProperties];
[[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie];

// 请求带上 cookie
NSDictionary *cookieHeaderDic = [NSHTTPCookie requestHeaderFieldsWithCookies:[[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies]];
[request setValue:[cookieHeaderDic objectForKey:@&quot;Cookie&quot;] forHTTPHeaderField:@&quot;Cookie&quot;];
</code></pre></div><p>3、OC 接收到 dart 传过来的 cookie 时顺带将 cookie 写入 webView</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code> NSString *jsStr = [NSString stringWithFormat:@&quot;document.cookie='%@=%@;expires=%ld'&quot;,name,value,exp];
[_webView stringByEvaluatingJavaScriptFromString:jsStr];
</code></pre></div><h3 id="实践应用"><a href="#实践应用" aria-hidden="true" class="header-anchor">#</a> 实践应用</h3> <p>WebView 控制 flutter 导航栏右侧 BarButtonItem</p> <ul><li>js 传递配置数组给 flutter，将 callback 存储在 js</li> <li>flutter 根据配置渲染 AppBar actions，设置点击回调将按钮类型回传 js</li> <li>js 根据 flutter 传过来的值调用之前缓存的 callback，调用结果返回给 flutter</li></ul> <p><img src="/assets/img/demo1.93d008ad.png" alt> <img src="/assets/img/demo2.d3783a00.png" alt></p> <h3 id="写在最后"><a href="#写在最后" aria-hidden="true" class="header-anchor">#</a> 写在最后</h3> <p>Flutter 里跑 webview 显然不是明智的做法，flutter 官方默认都关闭 PlatformView 功能。<br>
相对于 hybrid 和 RN 只有 JSC 通信，这里的 webview 又多了一层 flutter 通信。</p> <p>但是特殊场景下也不是不可以这么玩。类似在 RN / 小程序 里跑webview，在小程序里套 webview 减小包体积，避开审核快速迭代的做法不在少数。</p> <p>也有在微信小程序里利用 miniprograme.navigateTo 触发app.pageNotFound 做 IOC 的，虽然慢了点绕了点，但是提高了开发效率与迭代速度。</p> <p><img src="/assets/img/ok.abf87c44.png" alt><br> <strong>Anyway, Keep Balance.</strong></p> <h4 id="题外话-作为页面仔我们做跨端的优劣势"><a href="#题外话-作为页面仔我们做跨端的优劣势" aria-hidden="true" class="header-anchor">#</a> 题外话 - 作为页面仔我们做跨端的优劣势</h4> <p><del>怕被砖，先声明以下为纯扯淡内容</del><br> <img src="/assets/img/chiliu.5b6a2408.png" alt></p> <h6 id="优势"><a href="#优势" aria-hidden="true" class="header-anchor">#</a> 优势</h6> <ul><li>快，一次开发到处跑，对比安卓一堆机型一堆特殊 api，固定 webview 内核简直美滋滋</li> <li>快，hotreload爽的不行</li> <li>快，增量热更新绕过审核</li> <li>快，开发体验，MVVM，声明式开发加上组件库简直拼积木，iOS 命令式开发连尾灯都看不到</li> <li>快，CSS 牛逼，Android 还得整 xml，iOS 更是惨到手写代码布局</li> <li>快，开发环境简单，node / web 一把梭，native 一堆奇奇怪怪的配置</li></ul> <h6 id="劣势"><a href="#劣势" aria-hidden="true" class="header-anchor">#</a> 劣势</h6> <ul><li>慢，能力限制在 webview 的环境里，webview 限制了上限，扩展功能需要 native 排期施舍</li> <li>慢，单线程，渲染还会互斥，仰仗 native 帮忙分拆逻辑线程和UI线程进行优化</li> <li>慢，JIT 干不过 AOT</li> <li>慢，渲染干不过 native，多了层中间商 webview 赚差价，无限列表 webview 连 native 的尾灯都看不到
<ul><li>native 渲染: view -&gt; layout -&gt; renderNode -&gt; 合成 -&gt; GPU渲染</li> <li>webview: html -&gt; dom tree -&gt; render tree -&gt; render layer -&gt; 合成 -&gt; gpu渲染</li></ul></li></ul> <p>PS: 听说 flutter 很强，但它并不是前端专属玩具，因为 native 上手更有优势（尤其 Android）<br> <img src="/assets/img/cry.a06d963c.png" alt></p> <p>综上，<em><strong>快</strong></em> 才是我们的优势啊，钻牛角尖跟 native 比性能，何必呢。<br> <img src="/assets/img/smile.74ef0e9c.png" alt></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.3234abbf.js" defer></script><script src="/assets/js/3.091fb819.js" defer></script>
  </body>
</html>
