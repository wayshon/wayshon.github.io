<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactNative是怎么在iOS上跑起来的 | Wayshon 小站</title>
    <meta name="description" content="Wayshon Front-End Developer">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <link rel="preload" href="/assets/css/0.styles.f9ac1508.css" as="style"><link rel="preload" href="/assets/js/app.07f4407f.js" as="script"><link rel="preload" href="/assets/js/26.c989fb0b.js" as="script"><link rel="prefetch" href="/assets/js/10.ba64a31f.js"><link rel="prefetch" href="/assets/js/11.3586b7eb.js"><link rel="prefetch" href="/assets/js/12.61718b5e.js"><link rel="prefetch" href="/assets/js/13.1bfad86f.js"><link rel="prefetch" href="/assets/js/14.354d6e7e.js"><link rel="prefetch" href="/assets/js/15.cbbf53c3.js"><link rel="prefetch" href="/assets/js/16.5113d3aa.js"><link rel="prefetch" href="/assets/js/17.dc0b6250.js"><link rel="prefetch" href="/assets/js/18.55c217d8.js"><link rel="prefetch" href="/assets/js/19.f9fbb178.js"><link rel="prefetch" href="/assets/js/2.c4bfa02f.js"><link rel="prefetch" href="/assets/js/20.00c45c66.js"><link rel="prefetch" href="/assets/js/21.bfec624a.js"><link rel="prefetch" href="/assets/js/22.f5488922.js"><link rel="prefetch" href="/assets/js/23.c2a405e5.js"><link rel="prefetch" href="/assets/js/24.c744722a.js"><link rel="prefetch" href="/assets/js/25.1f30494d.js"><link rel="prefetch" href="/assets/js/27.93121c50.js"><link rel="prefetch" href="/assets/js/28.fc37c4fa.js"><link rel="prefetch" href="/assets/js/29.d9fcc3b3.js"><link rel="prefetch" href="/assets/js/3.c32e1224.js"><link rel="prefetch" href="/assets/js/30.91223dd9.js"><link rel="prefetch" href="/assets/js/31.5551858c.js"><link rel="prefetch" href="/assets/js/32.21208c3d.js"><link rel="prefetch" href="/assets/js/4.7b2aacbf.js"><link rel="prefetch" href="/assets/js/5.169304d2.js"><link rel="prefetch" href="/assets/js/6.be4d6965.js"><link rel="prefetch" href="/assets/js/7.00499994.js"><link rel="prefetch" href="/assets/js/8.76b3bfc9.js"><link rel="prefetch" href="/assets/js/9.9b509b33.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f9ac1508.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wayshon 小站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/archives.html" class="nav-link">归档</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://www.github.com/wayshon" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">side project</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://itunes.apple.com/cn/app/id1447258000" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关心宝
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  qr code
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://base64.imgqr.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  base64
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://calcbit.com/garbage-web/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  垃圾分类
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h2 id="reactnative是怎么在ios上跑起来的"><a href="#reactnative是怎么在ios上跑起来的" aria-hidden="true" class="header-anchor">#</a> ReactNative是怎么在iOS上跑起来的</h2> <p><code>2019-02-25</code></p> <ul><li>本文所有观点并不权威，都是平时看文档和实践中概括的，可能有错的地方，如有发现麻烦指出<code>wayshongg@gmail.com</code>谢谢。</li> <li>初始化流程:
<ul><li>创建根Controller:RCTRootView</li> <li>创建桥接对象:RCTBridge,用来处理js的jsccore，js、c++和OC交互。</li> <li>加载JS:[RCTBatchedBridge loadSource]</li> <li>创建模块表:[RCTBatchedBridge initModulesWithDispatchGroup],用来告诉js有哪些native模块可被调用</li> <li>往JS中插入OC模块表:[RCTJSCExecutor injectJSONText]</li> <li>jscore解析js</li> <li>js取native模块(属性模块)</li> <li>c++返回模块及其属性和方法</li> <li>编译render生成虚拟树</li> <li>Framework解析后维护一个消息队列MessageQueue.js(比如创建xx  view)</li> <li>native周期性去队列拉消息执行</li></ul></li> <li>native布局flex的神器：<code>Yoga</code></li> <li>jscore执行到 import X(比如Image)时，去模块表拿这个对象的属性和方法(不是每次都去native取，会有缓存映射表。每个组件有唯一tag和增删改查方法。reder的时候给MessageQueue队列塞事件，native通过c++去队列取事件，native通过调用yoga渲染出native ui</li> <li>通信机制：
<ul><li>js与native的通信绝大部分都是异步通信，又少部分同步的api，但我不知道干吗用的。</li> <li>jscore编译了js，jscore只能通过c++调用native。</li> <li>推(背压)：同步api，jscore调用c++,c++主动调用native。缺点，js疯狂执行，超过native执行能力导致主线程死掉</li> <li>拉：异步api，js另起线程，向MessageQueue队列扔事件，native层在runtime每帧回调后去队列捞，取队列的新值或者并值执行，更新UI的逻辑在主线程执行。据说这次RN重构要推同步方法，但是怎么做到不阻塞主线程就不知道了。</li> <li>总之，js是不能与oc(或者java)直接通信的，都是native层去捞事件，或者jscore编译后通过c++调用native。</li></ul></li> <li>js库: RN安卓与iOS统一用的jscore，weex安卓里用的v8。rn重构据说会高度抽象jscore那层方便换引擎。</li> <li>优化分割: RN是一次性加载Framework和业务js，新打开一个页面的时候是打开空的View，加载整个Framework和业务js。weex和crn是分割开这两个，比如预先new一个加载好Framework的View，打开新页面的时候直接加载业务js。这样解决了白屏问题，且容器可复用，业务代码销毁了可以加载另一份业务代码。</li> <li>我有一个问题：RN为什么卡。
<ul><li>这个问题我暂时还没有答案，下面纯属乱猜</li> <li>首先白屏的问题第一条就讲了，基础js重复加载的问题</li> <li>为什么运行时会卡呢，猜测和RN的通信机制有关。假设做一个滑块，在native里面完全可以在主线程里同步执行，识别到手势立马改变位置。但是在RN里就绕圈圈了：
<ul><li>首先识别到手势后，native调用c++</li> <li>c++再执行js里面的回调函数</li> <li>js执行完之后向MessageQueue队列塞任务</li> <li>native在一帧结束后来队列捞取并执行</li> <li>综上所述，RN与native比，起码是落后一帧，玩意再复杂点一帧的间隔时间比较长，就明显很卡了。</li></ul></li> <li>还有一个长列表的假设：
<ul><li>在native里table(list)是有一个identifer，用来标志是那种cell，假如页面能展示10行，内存里会有12个cell的实例，当页面滚动时，每次cell移除屏幕就会放入内存池备用，新进入屏幕的cell则去内存池取cell复用，而不是每次都是创建很多个cell。</li> <li>在RN里就不是native式的渲染了，RN也做了cell绑定key并复用，但是首先滚动事件得调一层c++传到js，js在去内存池取缓存的js cell，diff重绘Virtual Dom，再扔消息给MessageQueue队列，native捞了对了再扔给Yoga渲染。多出了一套流程。</li></ul></li></ul></li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.07f4407f.js" defer></script><script src="/assets/js/26.c989fb0b.js" defer></script>
  </body>
</html>
